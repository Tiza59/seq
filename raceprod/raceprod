#!/usr/bin/perl
use strict;
use warnings;
no warnings qw/ recursion /;

use Math::Prime::Util qw{ factor_exp nth_prime };

=head2 sequence

Let S_p be the set of positive integers that have no prime factor > p.
Let T(p, m) = \prod_{i \in S_p, i <= m}{i}
and r(p, k) = min i: p^k | T(p, i).

Then a(n) = min k: r(p_n, k) < r(i, k) for all i < p_n.

Thus eg r(2, 7) = 16, since 2.4.8.16 divides 2^7, but 2.4.8 does not.
Thus eg r(3, 6) = 18, since 3.6.9.12.18 divides 3^6 (note that 15 cannot
be used as it has a prime factor greater than 3).

Taking p_0 = 2, p_1 = 3 we have a(1) = 11 since r(3, 11) = 27 < r(2, 11) = 32,
but r(2, k) < r(3, k) for all smaller k.

We then find the sequence for a() as:
  1 11 60 79 418 240 534 292 800 3040 1121 4332 2818 1617 1872 8777 9655
  4563 12873 7441 4254 19483 10652 24376 87947 29195 15397 13577 10295
  10290 (>122880)

=cut

$| = 1;
my($limit_i) = shift(@ARGV) || 30;
my @p = map nth_prime($_), 1 .. $limit_i;
my %ip = map +($p[$_] => $_), 0 .. $limit_i - 1;
my $max_p = $p[$limit_i - 1];
my @reached = (0) x $limit_i;
my $done = '';
my $todo = $limit_i;

my $bs = "\x08 \x08";
my $k = 1;
K: while (1) {
    ++$k;
    # we only care about the highest prime factor of k
    my($fk) = reverse factor_exp($k);
    # if we can't look it up, it's beyond the range we care about
    my $pi = $ip{$fk->[0]} // next;
    # account for this before skipping anything
    my $ri = $reached[$pi] += $fk->[1];

    # skip if we already found a solution for this i
    next if vec $done, $pi, 1;
    # check if this is a solution; we may overshoot, so calculate that too
    my $max = 0;
    for my $rj (@reached[0 .. $pi - 1]) {
        next K if $rj >= $ri;
        $max = $rj if $max < $rj;
    }

    # we have a solution: a(pi) = max + 1
    vec($done, $pi, 1) = 1;
    printf "%s (%s) %s (%s: %s)\n",
            $pi, $p[$pi], $max + 1, $k, join(':', @reached[0 .. $pi]);
    last if 0 == --$todo;
}

__END__

Detail of results:
0 (2) 1 (2: 1)
1 (3) 11 (27: 10:11)
2 (5) 60 (640: 45:59:60)
3 (7) 79 (1120: 55:78:76:79)
4 (11) 418 (29645: 105:239:319:417:418)
5 (13) 240 (8788: 91:170:199:239:222:240)
6 (17) 534 (37570: 120:253:354:461:465:533:535)
7 (19) 292 (12635: 91:183:236:288:268:291:280:292)
8 (23) 800 (67298: 136:299:429:588:609:721:729:799:800)
9 (29) 3040 (754377: 190:537:897:1406:1667:2174:2426:2850:3039:3041)
10 (31) 1121 (120156: 136:349:519:737:789:953:994:1107:1120:1064:1121)
11 (37) 4332 (1233099: 210:585:1028:1662:2008:2663:3024:3610:3906:3943:4331:4332)
12 (41) 2818 (568875: 190:505:833:1279:1492:1924:2126:2484:2630:2609:2817:2771:2818)
13 (43) 1617 (220031: 153:402:625:918:1026:1266:1347:1530:1580:1527:1616:1561:1564:1617)
14 (47) 1872 (276830: 171:420:673:999:1121:1404:1511:1727:1792:1742:1858:1797:1808:1871:1872)
15 (53) 8777 (3398625: 231:728:1342:2277:2887:3980:4676:5761:6397:6615:7413:7547:7910:8494:8776:8777)
16 (59) 9655 (3995775: 231:746:1400:2385:3057:4233:5003:6187:6907:7171:8055:8234:8645:9307:9644:9654:9655)
17 (61) 4563 (1134905: 210:583:1003:1613:1947:2571:2915:3469:3747:3773:4143:4128:4248:4487:4562:4497:4425:4564)
18 (67) 12873 (5983837: 253:811:1540:2695:3511:4937:5912:7385:8332:8735:9891:10181:10764:11652:12137:12236:12290:12872:12873)
19 (71) 7441 (2450565: 231:676:1237:2059:2578:3500:4079:4968:5474:5620:6254:6326:6597:7047:7250:7214:7169:7440:7369:7441)
20 (73) 4254 (1012656: 190:564:983:1559:1865:2451:2771:3287:3539:3554:3891:3866:3975:4188:4253:4184:4117:4237:4158:4161:4254)
21 (79) 19483 (10725198: 276:899:1780:3187:4256:6111:7467:9479:10849:11541:13216:13751:14679:16013:16806:17068:17276:18211:18320:18740:19482:19483)
22 (83) 10652 (4099536: 231:746:1414:2404:3085:4278:5061:6254:6989:7263:8169:8343:8769:9446:9782:9808:9802:10231:10185:10329:10651:10556:10652)
23 (89) 24376 (14963570: 276:956:1917:3500:4730:6887:8503:10893:12573:13484:15536:16264:17452:19133:20176:20573:20900:22109:22320:22916:23885:23949:24375:24376)
24 (97) 87947 (123481000: 351:1358:3047:6098:8965:14008:18483:25042:30477:34246:41058:44694:49591:55996:60755:63665:66299:71602:73836:77248:81948:83669:86568:87946:87947)
25 (101) 29195 (19950732: 300:1006:2054:3789:5183:7614:9498:12264:14266:15384:17838:18777:20237:22265:23574:24126:24590:26081:26420:27187:28420:28569:29146:29194:28795:29195)
26 (103) 15397 (7242136: 253:836:1617:2849:3733:5295:6390:8020:9094:9574:10885:11238:11925:12941:13512:13649:13752:14432:14461:14738:15273:15213:15396:15306:14978:15090:15397)
27 (107) 13577 (5959365: 253:805:1540:2695:3506:4932:5902:7371:8311:8717:9875:10162:10742:11623:12109:12205:12260:12846:12834:13058:13514:13438:13576:13480:13176:13255:13514:13577)
28 (109) 10295 (3885196: 231:741:1385:2372:3030:4192:4949:6104:6809:7075:7942:8109:8518:9163:9486:9503:9493:9904:9848:9983:10294:10199:10276:10168:9911:9951:10119:10140:10295)
29 (113) 10290 (3883132: 231:741:1385:2372:3030:4192:4946:6104:6807:7074:7940:8105:8516:9162:9480:9501:9488:9902:9845:9979:10289:10198:10273:10166:9905:9947:10117:10137:10288:10290)

31 (131) 371986 (1076921525: 465:1875:4647:10143:16192:27094:38069:54496:69786:82164:102475:115888:132988:154676:172718:186020:198638:219284:231200:246756:266515:277131:291510:300989:305709:317851:333739:345368:360893:371985:362597:371986)
32 (137) 212457 (419103550: 406:1646:3880:8178:12595:20489:28027:39173:49075:56623:69427:77234:87359:100288:110617:117740:124376:136005:142029:150289:161032:166091:173440:177805:179359:185366:193578:199237:207154:212456:205919:210331:212457)
33 (139) 90896 (104827128: 351:1322:2945:5846:8558:13294:17446:23539:28528:31953:38178:41453:45881:51689:55952:58510:60801:65565:67504:70536:74711:76159:78705:79870:79777:81751:84701:86493:89280:90895:87335:88613:88890:90896)

35 (151) 86625 (97063857: 351:1308:2889:5736:8371:12972:16980:22862:27661:30922:36915:39996:44227:49762:53819:56226:58372:62898:64699:67552:71516:72872:75256:76322:76195:78041:80825:82502:85114:86624:83181:84365:84600:86466:84965:86625)
36 (157) 86165 (96244925: 351:1308:2889:5723:8348:12927:16929:22799:27566:30810:36769:39842:44046:49559:53587:55971:58112:62606:64403:67229:71186:72512:74877:75941:75807:77639:80417:82061:84672:86164:82737:83908:84140:85993:84497:86132:86165)
37 (163) 86234 (96368208: 351:1308:2889:5725:8350:12931:16939:22810:27580:30823:36786:39864:44069:49589:53623:56008:58150:62646:64450:67277:71229:72569:74939:75998:75865:77699:80473:82131:84734:86233:82801:83975:84207:86067:84564:86209:86233:86234)
38 (167) 76383 (79486823: 351:1262:2777:5456:7893:12157:15814:21190:25503:28389:33758:36459:40183:45083:48631:50670:52484:56433:57939:60379:63827:64924:66945:67797:67584:69139:71517:72908:75146:76382:73252:74220:74347:75934:74532:75924:75886:75827:76383)
39 (173) 100190 (119225372: 351:1348:3022:6039:8885:13852:18252:24711:30050:33744:40436:43978:48778:55050:59698:62526:65075:70272:72435:75767:80356:82000:84812:86148:86132:88331:91592:93604:96687:98502:94731:96178:96539:98764:97151:99118:99244:99326:100189:100190)

